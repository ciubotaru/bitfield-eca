CC=@CC@
export CC
datarootdir=@datarootdir@
prefix=@prefix@
exec_prefix=@prefix@
libdir=@libdir@
includedir=@includedir@
mandir=@mandir@
AR=ar
CFLAGS=@CFLAGS@
export CFLAGS
VERSION=@PACKAGE_VERSION@
export VERSION
RELEASE_DATE=June 17, 2017
export RELEASE_DATE
MANDIR=man
TESTDIR=tests
EXAMPLEDIR=examples
LD_LIBRARY_PATH := $(shell pwd):$(LD_LIBRARY_PATH)
export LD_LIBRARY_PATH
PACKAGE_VERSION=@PACKAGE_VERSION@

.PHONY:test check man shared static install install-lib install-man install-header clean distclean uninstall uninstall-lib uninstall-man uninstall-header example examples

all: shared static man

shared: libeca.so.$(VERSION)
libeca.so.$(VERSION): eca.c
	$(CC) $(CFLAGS) -c -fpic eca.c -o eca-shared.o -I.
	$(CC) $(CFLAGS) -shared -Wl,-soname,libeca.so.1 -o libeca.so.$(VERSION) eca-shared.o -I. `pkg-config --libs libbitfield`
	for i in libeca.so.1 libeca.so; do ln -svf libeca.so.$(VERSION) $$i; done

static: libeca.a
libeca.a: eca.c
	$(CC) $(CFLAGS) -c eca.c -o eca-static.o -I.
	$(AR) rcs libeca.a eca-static.o

man:
	$(MAKE) -C $(MANDIR)

test: check

check:
	$(MAKE) -C $(TESTDIR)

examples: example

example:
	$(MAKE) -C $(EXAMPLEDIR)

install: install-lib install-header install-man

install-lib:
	mkdir -p $(DESTDIR)$(libdir)
	for i in libeca.so.1 libeca.so libeca.so.$(VERSION); do if [ -e $(DESTDIR)$(libdir)/$$i ]; then rm -v $(DESTDIR)$(libdir)/$$i; fi; done
	install -m 0644 libeca.so.$(VERSION) $(DESTDIR)$(libdir)
	ln -sv libeca.so.$(VERSION) $(DESTDIR)$(libdir)/libeca.so.1
	ln -sv libeca.so.$(VERSION) $(DESTDIR)$(libdir)/libeca.so
	install -m 0644 libeca.a $(DESTDIR)$(libdir)

install-header:
	mkdir -p $(DESTDIR)$(includedir)
	install -m 644 eca.h $(DESTDIR)$(includedir)/eca.h

install-man:
	$(MAKE) -C $(MANDIR) install

uninstall: uninstall-lib uninstall-header uninstall-man

uninstall-lib:
	for i in libeca.so.1 libeca.so libeca.so.$(VERSION) libeca.a; do if [ -e $(DESTDIR)$(libdir)/$$i ]; then rm -v $(DESTDIR)$(libdir)/$$i; fi; done

uninstall-header:
	if [ -e $(DESTDIR)$(includedir)/eca.h ]; then rm -v $(DESTDIR)$(includedir)/eca.h; fi

uninstall-man:
	$(MAKE) -C $(MANDIR) uninstall

clean:
	rm -rvf *.a *.o *.so*
	$(MAKE) -C $(TESTDIR) clean
	$(MAKE) -C $(EXAMPLEDIR) clean
	$(MAKE) -C $(MANDIR) clean

distclean: clean
	rm config.log config.status config.h Makefile
	$(MAKE) -C $(MANDIR) distclean
	$(MAKE) -C $(TESTDIR) distclean
	$(MAKE) -C $(EXAMPLEDIR) distclean
